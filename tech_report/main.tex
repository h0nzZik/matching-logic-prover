\documentclass{article}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage[utf8]{inputenc}
\usepackage{proof}
\usepackage{txfonts}
\usepackage{mathtools}
\usepackage{authblk}

% Import packages for syntax highlight code.
\usepackage{listings}
\usepackage{xcolor}
\lstdefinelanguage{maude}
{
    keywords={sort, sorts, op, ops, var, vars, eq, ceq, mb , endfm, fmod, is, endm, including},
    morecomment=[l]{---}
}
\lstset{
	language=maude,
	basicstyle=\ttfamily,
	keywordstyle=\color{blue}
}

\theoremstyle{plain}
\newtheorem{thm}{Theorem}
\newtheorem{prop}[thm]{Proposition}
\newtheorem{cor}[thm]{Corollary}
\newtheorem{defn}[thm]{Definition}
\newtheorem{eg}[thm]{Example}
\newtheorem{rmk}[thm]{Remark}
\newtheorem{lemma}[thm]{Lemma}

\DeclarePairedDelimiter\ceil{\lceil}{\rceil}
\DeclarePairedDelimiter\floor{\lfloor}{\rfloor}

\def\imp{\to}
\def\land{\mathbin\&}
\def\ml2pl{\textsf{ml2pl}}

% Label inference rules.
\newcommand{\rl}[1]{\text{\scriptsize{(#1)}}}

% Title and authors

\title{Technical Report\\ 
	   The Deduction System of Matching Logic}
\author[1]{Formal Systems Laboratory}
\affil[1]{University of Illinois, Urbana-Champaign, USA}


\begin{document}

\maketitle

\begin{abstract}

Abstract goes here.

\end{abstract}

\section{Syntax}

Formulas of matching logic, called \emph{patterns}, are written in a formal language, denoted as $\mathcal{L}$, whose grammar is listed in~\eqref{ml_grammar}. The language $\mathcal{L}$ is many-sorted. A signature of $\mathcal{L}$ contains not only a finite set $\Sigma$ of \emph{symbols}, but also a finite nonempyty set $S$ of \emph{sorts}. Each symbol $\sigma \in \Sigma$ is, of course, sorted, with a fixed nonempty arity. We write $\sigma \in \Sigma_{s_1,\dots,s_n,s}$ to emphasize that $\sigma$ takes $n$ arguments (with argument sorts $s1,\dots,s_n$) and returns a pattern in sort $s$, but we hope in most cases sorting is clear from context.

The grammar for $\mathcal{L}$, as defined below, is almost identical to first-order logic, except that in $\mathcal{L}$ there is no difference between relational (predicate) and functional symbols, and we accept first-order terms as patterns in matching logic. 
\begin{align}
\label{ml_grammar}
P \Coloneqq\  & x \\
       \mid\  & P_1 \wedge P_2 \nonumber \\
       \mid\  & \neg P \nonumber \\
       \mid\  & \forall x . P \nonumber \\
       \mid\  & \sigma(P_1,\dots,P_n), \nonumber
\end{align}
where the universal quantifier ($\forall x$) behaves the same as in first-order logic, with alpha-renaming always assumed.

For simplicity, we did not mention sorting in the grammar definition, and assume it should be clear to all readers. For example, in $P_1 \wedge P_2$, both patterns $P_1$ and $P_2$ should have the same sort, and that sort is the sort of $P_1 \wedge P_2$. The sort of $\forall x . P$ is the sort of $P$, while the sort of variable $x$ does not matter. To see why it is the case, consider the pattern $\exists x . list(x, 1 \cdot 3 \cdot 5)$, which is the set of all memory configurations that has a list $(1,3,5)$ in it.

Propositional connectives are always assumed, including disjunction ($\vee$), implication ($\to$), and equivalence ($\leftrightarrow$). Existential quantifier ($\exists x$) is defined by universal quantifier ($\forall x$) in the normal way. The bottom pattern ($\bot_s$) and the top pattern ($\top_s$) in sort $s$ are given by $x \wedge \neg x$ and $\neg \bot_s$, respectively, where $x$ is a variable in sort $s$. It does not matter which variable we pick.


\subsection{Extended Syntax}
The formal language $\mathcal{L}$ is often extended with \emph{definedness} symbols. For $s_1, s_2$ are two sorts, the definedness symbol $\ceil*{\_}_{s_1}^{s_2} \in \Sigma_{s_1,s_2}$ is a unary symbol with one argument sort $s_1$ and the result sort $s_2$. For a pattern $P$ who has sort $s_1$, the pattern $\ceil*{\_}_{s_1}^{s_2} \left(P\right)$ is often written as $\ceil*{P}_{s_1}^{s_2}$, or simply $\ceil*{P}$.

Definedness symbols carry specific intended semantics. For each definedness symbol $\ceil*{\_}_{s_1}^{s_2}$, we add the pattern $\ceil*{x}_{s_1}^{s_2}$ as an axiom to the deductive system, where $x$ is a variable who has sort $s_1$. It does not matter which variable we pick.

With definedness symbols, we extends the formal language $\mathcal{L}$ with 
\begin{align*}
&\floor*{P}_{s_1}^{s_2} \coloneqq {\neg} \ceil*{\neg P}_{s_1}^{s_2} \\
&P_1 =_{s_1}^{s_2} P_2 \coloneqq \floor*{P_1 \leftrightarrow P_2}_{s_1}^{s_2} \\
&P_1 \neq_{s_1}^{s_2} P_2 \coloneqq \neg (P_1 =_{s_1}^{s_2} P_2) \\
&P_1 \subseteq_{s_1}^{s_2} P_2 \coloneqq \floor*{P_1 \to P_2}_{s_1}^{s_2} \\
&x \in_{s_1}^{s_2} P \coloneqq x \subseteq_{s_1}^{s_2} P.
\end{align*}

\begin{rmk}
	To prevent writing tangled subscripts and superscripts that indicate sorts of variables and patterns all the time, we omit them as much as possible, unless there is a chance of confusing things. A statement with sorting subscripts and superscripts omitted is treated as (possibly many) statements with the omitting sorting subscripts and superscripts completed in all possible well-formed ways.
\end{rmk}

\section{Deductive system}
A deductive system is a recursive set of patterns as \emph{axioms} and a finite set of \emph{inference rules}. The deductive system of matching logic that we introduce in this section has been proved \emph{sound} and \emph{complete}.

\subsection{The Deductive System}

Axioms are given by the following axiom schemata where $P, Q, R$ are arbitrary patterns and $x, y$ are logic variables.
\begin{itemize}
\item (K1) $P \to (Q \to P)$
\item (K2) $(P \to (Q \to R)) \to ((P \to Q) \to (P \to R))$
\item (K3) $(\neg P \to \neg Q) \to (Q \to P)$
\item (K4) $\forall x . P \to P[y/x]$
\item (K5) $\forall x . (P \to Q) \to (P \to \forall x . Q)$ if $x$ does not occur free in $P$
\item (K6) $P_1 = P_2 \to (Q[P_1/x] \to Q[P_2/x])$
\item (Df)  $\ceil{x}$
\item (M1) $x \in y = (x = y)$
\item (M2) $x \in P \wedge Q = (x \in P) \wedge (x \in Q)$
\item (M3) $x \in \neg P = \neg (x \in P)$
\item (M4) $x \in \forall y . P = \forall y . x \in P$ where $x$ is distinct from $y$
\item (M5) $x \in \sigma(\dots,P_i,\dots) = \exists y . y \in P_i \wedge x \in \sigma(\dots,y,\dots)$ where $y$ occurs free in the left hand side of the equation.
\end{itemize}

\begin{rmk}
	Substitution is denoted as $Q[P/x]$. Alpha-renaming is always assumed in order to avoid free variables capturing.
\end{rmk}

Inference rules include
\begin{itemize}
\item (Modus Ponens) From $P$ and $P \to Q$, deduce $Q$.
\item (Universal Generalization) From $P$, deduce $\forall x . P$. 
\item (Membership Introduction) From $P$, deduce $\forall x . (x \in P)$, where $x$ does not occur free in $P$.
\item (Membership Elimination) From $\forall x . (x \in P)$, deduce $P$, where $x$ does not occur free in $P$.
\end{itemize}

\begin{thm}
The proof system is sound and complete.
\end{thm}
\begin{proof}
  No proof.
\end{proof}

\subsection{Metatheorems of the deductive system}

Writing formal proofs is never easy. Derivations are prone to be lengthy and boring. To ease such difficulty, we here in this section introduce a dozen of lemmas (i.e., metatheorems) of the deductive system. Metatheorems discover all kinds of properties of the deductive system, from the simplest ``$\vdash P=P$'' to the complexest deduction theorem and the framing rule. 

\begin{prop}[Tautology] \label{prop:taut}
	For any propositional tautology $\mathcal{A}(p_1,\dots,p_n)$ where $p_1,\dots,p_n$ are all propositional variables in $\mathcal{A}$, and for any patterns $P_1,\dots,P_n$, $$ \vdash \mathcal{A}(P_1,\dots,P_n).$$
\end{prop}
\begin{proof}
	No proof.
\end{proof}

\begin{cor}
  $\vdash \top$.
\end{cor}
\begin{proof}
By definition, $\top = \neg \bot = \neg (x \wedge \neg x)$, where $x$ is a matching logic variable who has the same sort with $\top$. Let proposition $\mathcal{A} = \neg (p \wedge \neg p)$ with $p$ is a propositional variable. Then $\mathcal{A}$ is a propositional tautology. By Proposition~\ref{prop:taut}, $\top = \mathcal{A}[x/p]$ is derivable in the proof system, i.e., $\vdash \top$.
\end{proof}

Equalities plays an important role in matching logic. Axiom (K6) is very powerful even though it looks quite simple. It basically says that whenever one establishes that $P = Q$, then the two patterns are interchangeable everywhere in any patterns, as concluded in the next lemma.

\begin{lemma}
	\label{prop:ereplacement}
	If $\vdash P_1 = P_2$ and $\vdash Q[P_1 / x]$, then $\vdash Q[P_2 / x]$.
\end{lemma}

\begin{proof}
$$
\infer[\rl{MP}]{\vdash Q[P_2 / x]}
{\infer[\rl{MP}]{\vdash Q[P_1 / x] \to Q[P_2 / x]}
	   {\infer{P_1 = P_2}{\cdot}
	   &\infer[\rl{K6}]{P_1 = P_2 \to \left(Q[P_1 / x] \to Q[P_2 / x]\right)}{\cdot}}
	&\infer{\vdash Q[P_1 / x]}{\cdot}}
$$
\end{proof}

Before we introduce how to establish an equality in matching logic, we first prove some simplification rules about the top and bottom patterns. 

\begin{lemma}
The following propositions hold for any pattern $P$.
\begin{enumerate}
	\item $\vdash P$ iff $\vdash P = \top$.
	\item $\vdash \neg P$ iff $\vdash P = \bot$.
	\item $\vdash \left(P \wedge \top\right) = P$.
	\item $\vdash (P \wedge \bot) = \bot$.
	\item $\vdash (P \vee \top) = \top$.
	\item $\vdash (P \vee \bot) = P$.
	\item $\vdash \forall x . \top = \top$.
	\item $\vdash \forall x . \bot = \bot$.
	\item $\vdash \exists x . \top = \top$.
	\item $\vdash \exists x . \bot = \bot$.
	\item $\vdash (x \in \top) = \top$.
	\item $\vdash (x \in \bot) = \bot$.
\end{enumerate}
\end{lemma}
\begin{proof}
	There is little intelligence in the proof. We will show how to prove (1) and (3), and the rest should be similar.
\end{proof}

The next proposition is useful when one wants to establish an equality pattern.

\begin{prop}
	\label{prop:eestablish}
	$\vdash P \leftrightarrow Q$ iff $\vdash P = Q$.
\end{prop}

\begin{proof}
That the right hand side implies the left is easy, so we left the proof as an exercise to the readers. In the following, we only prove that the left implies the right. By definition, $P = Q$ is the syntactic sugar of $\neg \ceil{\neg \left(P \leftrightarrow Q\right)}$, so we have the following derivation.

$$
\infer[\rl{$\in$-Intro}]{\neg \ceil{\neg \left(P \leftrightarrow Q\right)}}
{\infer[\rl{$\forall x$-Gen}]{\forall x . \left(x \in \neg \ceil{\neg \left(P \leftrightarrow Q\right)} \right)}
{\infer[\rl{K6, M3}]{x \in \neg \ceil{\neg \left(P \leftrightarrow Q\right)}}
{\infer[\rl{K6, M5}]{\neg \left( x \in  \ceil{\neg \left(P \leftrightarrow Q\right)} \right) }
{\infer[\rl{Sugar, K3, M3}]{\neg \exists y . \left(x \in \ceil{y} \wedge y \in \neg \left(P \leftrightarrow Q\right)\right)}
{\forall y .(\neg (x \in \ceil{y}) \vee (y \in P \leftrightarrow Q)}}}}}.
$$


\end{proof}

\begin{prop}[$\vee$-Introduction] \label{prop:vee-introduction}
	$\vdash P$ implies $\vdash P \vee Q$.
\end{prop}
\begin{proof}
	Use Proposition~\ref{prop:taut} and Modus Ponens.
	Note that in general, $\vdash P \vee Q$ does not imply $\vdash P$ or $\vdash Q$.
\end{proof}

\begin{prop}[Functional Substitution]
	$\vdash \exists y . (Q = y) \to (P[Q / x] \to \exists x . P(x))$.
\end{prop}


\begin{prop}[$\wedge$-Introduction and Elimination]
\label{prop:wedge}
$\vdash P$ and $\vdash Q$ iff $\vdash P \wedge Q$.
\end{prop}
\begin{proof}
Use Proposition~\ref{prop:taut} and Modus Ponens.
\end{proof}

\begin{prop}[Equality Introduction]
	$\vdash P = P$.
\end{prop}
\begin{proof}
	Use Membership Introduction and Proposition~\ref{prop:taut}.
\end{proof}



\begin{cor} \label{cor:top}
$\vdash P$ implies $\vdash P = \top$ .
\end{cor}

\begin{prop} \label{prop:var1}
$\vdash x \in \ceil*{y}$.
\end{prop}
\begin{proof}
\begin{align*}
&\vdash x \in \ceil*{y} \\
{\text{if}}& \vdash \forall x . (x \in \ceil*{y}) \tag{$K5$, $K6$, and Modus Ponens} \\
{\text{iff}}& \vdash \ceil*{y}.
\end{align*}
\end{proof}

\begin{prop} \label{prop:p->ceilp}
$\vdash P \to \ceil*{P}$.
\end{prop}
\begin{proof}
\begin{align*} 
&\vdash P \to \ceil*{P} \\
{\text{iff}}& \vdash \forall x . (x \in P \to \ceil*{P}) \\
{\text{if}}&  \vdash x \in P \to \ceil*{P} \\
{\text{iff}}& \vdash x \in P \to x \in \ceil*{P} \\
{\text{iff}}& \vdash x \in P \to \exists y . (y \in P \wedge x \in \ceil*{y}) \\
{\text{iff}}& \vdash x \in P \to \neg \forall y . (y \not \in P \vee x \not \in \ceil*{y}) \\
{\text{iff}}& \vdash \forall y . (y \not \in P \vee x \not \in \ceil*{y}) \to x \not \in P \\
{\text{if}}&  \vdash x \not \in P \vee x \not \in \ceil*{x} \to x \not \in P \\
{\text{iff}}& \vdash x \in P \to x \in P \wedge x \in \ceil*{x} \\
{\text{iff}}& \vdash x \in P \to x \in \ceil*{x} \\
{\text{if}}&  \vdash x \in \ceil*{x} \\
\end{align*}
\paragraph{Remark} Similarly we can show $\vdash \floor*{P} \to P$.
\end{proof}

\begin{prop} \label{prop:floor}
$\vdash \forall x . (x \in P) = \floor*{P}$, where $x$ occurs free in $P$.
\end{prop}
\begin{proof}
By Proposition~\ref{prop:eestablish} and~\ref{prop:wedge}, it suffices to show \begin{equation} \label{eq:prop11-1}
\vdash \forall x . (x \in P) \to \floor*{P}
\end{equation}
and
\begin{equation} \label{eq:prop11-2}
\vdash \floor*{P} \to \forall x . (x \in P).
\end{equation}

To show~\eqref{eq:prop11-1},

\begin{align*}
&\vdash \forall x . (x \in P) \to \floor*{P} \\
{\text{iff}}& \vdash \forall x . \ceil*{x \wedge P} \to \neg \ceil*{\neg P} \\
{\text{iff}}& \vdash \ceil*{\neg P} \to \exists x . \neg \ceil*{x \wedge P} \\
{\text{iff}}& \vdash \forall y . (y \in ( \ceil*{\neg P} \to \exists x . \neg \ceil*{x \wedge P})) \\
{\text{if}}& \vdash y \in ( \ceil*{\neg P} \to \exists x . \neg \ceil*{x \wedge P} \\
{\text{iff}}& \vdash \exists z_1 . (z_1 \not \in P \wedge y \in \ceil*{z_1}) \to \\ & \quad \quad \exists x . \neg (\exists z_2 . (z_2 = x \wedge z_2 \in P \wedge y \in \ceil*{z_2})) \\
{\text{iff}}& \vdash \exists z_1 . (z_1 \not \in P \wedge \top) \to \tag{Proposition~\ref{prop:var1}, \ref{prop:ereplacement}, and Corollary~\ref{cor:top}}\\
& \quad \quad \exists x . \neg (\exists z_2 . (z_2 = x \wedge z_2 \in P \wedge \top)) \\
{\text{iff}}& \vdash \exists z_1 . (z_1 \not \in P) \to \exists x . \neg (\exists z_2 . (z_2 = x \wedge z_2 \in P)) \\
{\text{iff}}& \vdash \forall x . (\exists z_2 . (z_2 = x \wedge z_2 \in P)) \to \forall z_1 . (z_1 \in P) \\
{\text{if}}& \vdash \forall z_1 . (\forall x . (\exists z_2 . (z_2 = x \wedge z_2 \in P)) \to (z_1 \in P)) \\
{\text{if}}& \vdash \forall x . (\exists z_2 . (z_2 = x \wedge z_2 \in P)) \to (z_1 \in P).
\end{align*}
Since $\vdash \forall x . (\exists z_2 . (z_2 = x \wedge z_2 \in P)) \to \exists z_2 . (z_2 = z_1 \wedge z_2 \in P) $, it suffices to show
\begin{align*}
&\vdash \exists z_2 . (z_2 = z_1 \wedge z_2 \in P) \to (z_1 \in P) \\
{\text{iff}}& \vdash z_1 \not \in P \to \forall z_2 . (z_2 \neq z_1 \vee z_2 \not \in P) \\
{\text{if}}& \vdash \forall z_2 . (z_1 \not \in P \to z_2 \neq z_1 \vee z_2 \not \in P) \\
{\text{if}}& \vdash z_1 \not \in P \to z_2 \neq z_1 \vee z_2 \not \in P \\
{\text{if}}& \vdash z_2 = z_1 \wedge z_2 \in P \to z_1 \in P.
\end{align*}
And we proved~\eqref{eq:prop11-1}.

Similarly, to show~\eqref{eq:prop11-2}, 
\begin{align*}
&\vdash \floor*{P} \to \forall x . (x \in P)  \\
{\text{iff}}& \vdash \exists x . \neg \ceil*{x \wedge P} \to \ceil*{\neg P} \\
{\text{iff}}& \vdash \forall y . (y \in \exists x . \neg \ceil*{x \wedge P} \to \ceil*{\neg P}) \\
{\text{if}}& \vdash y \in \exists x . \neg \ceil*{x \wedge P} \to \ceil*{\neg P} \\
{\text{iff}}& \vdash \exists x . \neg \exists z_2 . (z_2 = x \wedge z_2 \in P) \to \exists z_1 . (z_1 \not \in P) \\
{\text{iff}}& \vdash \forall z_1 . (z_1 \in P) \to \exists z_2 . (z_2 = x \wedge z_2 \in P)\\
{\text{iff}}& \vdash x \in P \to \exists z_2 . (z_2 = x \wedge z_2 \in P).
\end{align*}
We proved~\eqref{eq:prop11-2}.

\paragraph{Remark} If $x$ occurs free in $P$, the result does not hold. For example, let $P$ be $upto(x)$ where $upto(\cdot)$ is interpreted to $upto(n) = \{0, 1, \dots, n\}$ on $\mathbb{N}$. 
\end{proof}

\paragraph{Remark} From Membership Introduction and Elimination inference rules and Proposition~\ref{prop:floor}, $\vdash P$ iff $\vdash \floor*{P}$.

\begin{prop}[Classification Reasoning] \label{prop:classificationreasoning}
	For any $P$ and $Q$, from $\vdash P \to Q$ and $\vdash \neg P \to Q$ deduce $\vdash Q$.
\end{prop}
\begin{proof}
	From $\vdash \neg P \to Q$ deduce $\vdash \neg Q \to P$. Notice that $\vdash P \to Q$, so we have $\vdash \neg Q \to Q$, i.e., $\vdash \neg \neg Q \vee Q$ which concludes the proof.
\end{proof}
\begin{cor} \label{cor:classificationreasoning}
	For any $P_1$, $P_2$, and $Q$ are patterns with $\vdash P_1 \vee P_2$, from $\vdash P_1 \to Q$ and $\vdash P_2 \to Q$, deduce $\vdash Q$.
\end{cor}

\begin{defn}[Predicate Pattern]
A pattern $P$ is called a predicate pattern or a predicate if $\vdash (P = \top) \vee (P = \bot)$.
\end{defn}
\paragraph{Remark} Predicate patterns are closed under all logic connectives.
\paragraph{Remark} For any $P$, $\ceil*{P}$ is a predicate pattern.

\begin{prop} \label{prop:017}
	$\vdash (\ceil*{P} = \bot) = (P = \bot)$ and $\vdash (\floor*{P} = \top) = (P = \top)$.
\end{prop}
\begin{proof}
	It is easy to prove one derivation from the other, so we only prove the first one. By Proposition~\ref{prop:eestablish}, it suffices to prove
	\begin{equation} \label{eq:prop:017:a}
	\vdash (\ceil*{P} = \bot) \to (P = \bot)
	\end{equation}
	and
	\begin{equation} \label{eq:prop:017:b}
	\vdash (P = \bot) \to (\ceil*{P} = \bot)
	\end{equation}
	
	The proof of~\eqref{eq:prop:017:b} is trivial and we left it as an exercise. We now prove~\eqref{eq:prop:017:a} through the following backward reasoning.
	
	\begin{align}
	&\vdash (\ceil*{P} = \bot) \to (P = \bot)  \nonumber \\
	\text{iff} \quad &\vdash \forall y . (y \in ((\ceil*{P} = \bot) \to (P = \bot))) \nonumber \\
	\text{if} \quad &\vdash y \in ((\ceil*{P} = \bot) \to (P = \bot)) \nonumber \\
	\text{iff} \quad &\vdash (y \in (\ceil*{P} = \bot) \to (y \in (P = \bot)). \label{eq:prop:017:a:1}
	\end{align}
	While for any pattern $Q$, 
	\begin{align*}
	&\vdash y \in (Q = \bot) \\
	\text{iff} \quad &\vdash y \in \neg \ceil*{\neg (Q \leftrightarrow \bot)} \\
	\text{iff} \quad &\vdash y \in \neg \ceil*{Q}\\
	\text{iff} \quad &\vdash \neg \exists z . (z \in Q \wedge y \in \ceil*{z}) \\
	\text{iff} \quad &\vdash \neg \exists z . (z \in Q) 
	\end{align*}
	So we continue to prove~\eqref{eq:prop:017:a:1} by showing
	\begin{align*}
&\vdash (y \in (\ceil*{P} = \bot)) \to (y \in (P = \bot))  \\
\text{iff} \quad &\vdash \neg \exists z . (z \in \ceil*{P}) \to \neg \exists z . (z \in P) \\
\text{iff} \quad &\vdash \exists z . (z \in P) \to  \exists z . (z \in \ceil*{P}) \\
\text{iff} \quad &\vdash \exists z . (z \in P) \to \exists z . (\exists z_1 . (z_1 \in P \wedge z \in \ceil*{z_1}))\\
\text{iff} \quad &\vdash \exists z . (z \in P) \to \exists z . \exists z_1 . (z_1 \in P) \\
\text{iff} \quad &\vdash \exists z_1 . (z_1 \in P) \to \exists z . \exists z_1 . (z_1 \in P).
	\end{align*}
	And we finish the proof by noticing the fact that for any pattern $Q$ and variable $x$, 
	$$ \vdash Q \to \exists x . Q.$$
	
\end{proof}



\begin{prop} \label{prop:predicateabsorb}
For any predicate $P$, $\vdash (P \neq \top) = (P = \bot)$ and $\vdash (P \neq \bot) = (P = \top)$.
\end{prop}
\begin{proof}
We only prove the first derivation, by showing both
\begin{equation}\label{eq:predicateabsort1}
\vdash (P \neq \top) \to (P = \bot)
\end{equation}
and
\begin{equation}\label{eq:predicateabsort2}
\vdash (P = \bot) \to (P \neq \top).
\end{equation}
Proving~\eqref{eq:predicateabsort2} is trivial. We now prove~\eqref{eq:predicateabsort1}, which is also trivial by transforming disjunction to implication.
\end{proof}
\begin{prop} \label{prop:predicatevee}
For any pattern $Q$ and any predicate pattern $P$, $\vdash P \vee Q$ iff $\vdash P \vee \floor*{Q}$.
\end{prop}
\begin{proof}
($\Leftarrow$) is obtained immediately by the remark of Proposition~\ref{prop:p->ceilp}. We now prove ($\Rightarrow$). 

Because $\vdash Q = \top \vee Q \neq \top$, it suffices to show
\begin{equation} \label{eq:predicatevee-01}
\vdash Q = \top \to (P \vee \floor*{Q} = \top)
\end{equation}
and
\begin{equation} \label{eq:predicatevee-02}
\vdash Q \neq \top \to (P \vee \floor*{Q} = \top)
\end{equation}
by Corollary~\ref{cor:classificationreasoning}, and the fact that $\vdash P \vee \floor*{Q} = \top$ and $\vdash \top$ imply $\vdash P \vee \floor*{Q}$. 

The proof of~\eqref{eq:predicatevee-01} is straightforward as follows.
\begin{align*}
&\vdash Q = \top \to (P \vee \floor*{Q} = \top) \\
\text{if} \quad &\vdash Q = \top \to (P \vee \floor*{\top} = \top) \\
\text{if} \quad &\vdash Q = \top \to (\top = \top) \\
\text{if} \quad &\vdash \top.
\end{align*}

The proof of~\eqref{eq:predicatevee-02} needs more effort:
\begin{align*}
&\vdash Q \neq \top \to (P \vee \floor*{Q} = \top) \\
\text{iff} \quad &\vdash (Q = \top) \vee (P \vee \floor*{Q} = \top) \\
\text{iff} \quad &\vdash (\floor*{Q} = \top) \vee (P \vee \floor*{Q} = \top) \\
\text{iff} \quad &\vdash \floor*{Q} \neq \top \to (P \vee \floor*{Q} = \top) \\
\text{iff} \quad &\vdash \floor*{Q} = \bot \to (P \vee \floor*{Q} = \top) \\
\text{if} \quad &\vdash \floor*{Q} = \bot \to (P \vee \bot = \top) \\
\text{iff} \quad &\vdash \floor*{Q} = \bot \to (P = \top) \\
\text{if} \quad &\vdash Q = \top \vee P = \top.
\end{align*}
Notice that $P$ is a predicate pattern, so it suffices to show
\begin{equation*}
\vdash P = \top \to (Q = \top \vee P = \top),
\end{equation*}
whose validity is obvious, and
\begin{equation*}
\vdash P = \bot \to (Q = \top \vee P = \top),
\end{equation*}
which is proved by showing
\begin{equation} 
\vdash P = \bot \to Q = \top.
\end{equation}
Because $\vdash P \vee Q$, it suffices to show
\begin{align*}
&\vdash P = \bot \to (P \vee Q) \to (Q = \top) \\
\text{if} \quad &\vdash P = \bot \to (\bot \vee Q) \to (Q = \top) \\
\text{iff} \quad &\vdash P = \bot \to Q \to (Q = \top) \\
\text{if} \quad &\vdash Q \to (Q = \top) \\
\text{iff} \quad &\vdash (Q \neq \top) \to \neg Q \\
\text{iff} \quad &\vdash (\floor*{Q} = \bot) \to \neg Q.
\end{align*}
Notice we have $\vdash Q \to \floor*{Q}$, which means $\vdash \neg \floor*{Q} \to \neg Q$, so it suffices to show
\begin{align*}
&\vdash (\floor*{Q} = \bot) \to \neg \floor*{Q} \\
\text{iff} \quad &\vdash (\floor*{Q} = \bot) \to \neg \bot \\
\text{iff} \quad &\vdash (\floor*{Q} = \bot) \to \top \\
\text{iff} \quad &\vdash \top.
\end{align*}
And this concludes the proof.
\end{proof}


\begin{prop}[Deduction Theorem]
If $\Gamma \cup \{P\} \vdash Q$ and the derivation does not use \mbox{$\forall x$-Generalization} where $x$ is free in $P$, then $\Gamma \vdash \floor*{P} \to Q$. 
\end{prop}
\begin{proof}
The proof is by induction on $n$, the length of the derivation of $Q$ from $\Gamma \cup \{P\}$.

Base step: $n = 1$, and $Q$ is an axiom, or $P$, or a member of $\Gamma$. If $Q$ is an axiom or a member of $\Gamma$, then $\Gamma \vdash Q$ and as a result, $\Gamma \vdash \floor*{P} \to Q$. If $Q$ is $P$, then $\Gamma \vdash \floor*{P} \to Q$ by Proposition~\ref{prop:p->ceilp}.

Induction step: Let $n > 1$. Suppose that if $P'$ can be deduced from $\Gamma \cup \{P\}$ without using $\forall x$-Generalization where $x$ is free in $P$, in a derivation containing fewer than $n$ steps, then $\Gamma \vdash \floor*{P} \to P'$.

Case 1: $Q$ is an axiom, or $P$, or a member of $\Gamma$. Precisely as in the Base step, we show that $\vdash \floor*{P} \to Q$.

Case 2: $Q$ follows from two previous patterns in the derivation by an application of Modus Ponens. These two patterns must have the forms $Q_1$ and $Q_1 \to Q$, and each one can certainly be deduced from $\Gamma \cup \{P\}$ by a derivation with fewer than $n$ steps, by just omitting the subsequent members from the original derivation from $\Gamma \cup \{P\} \vdash Q$. So we have $\Gamma \cup \{P\} \vdash Q_1$ and $\Gamma \cup \{P\} \vdash Q_1 \to Q$, and, applying the hypothesis of induction, $\Gamma \vdash \floor*{P} \to Q_1$ and $\Gamma \vdash \floor*{P} \to (Q_1 \to Q)$. It follows immediately that $\Gamma \vdash \floor*{P} \to Q$.

Case 3: $Q$ follows from a previous pattern in the derivation by an application of $\forall x_i$-Generalization where $x_i$ does not occur free in $P$. So $Q$ is $\forall x_i . Q_1$, say, and $Q_1$ appears previously in the derivation. Thus $\Gamma \cup \{P\} \vdash Q_1$, and the derivation has fewer than $n$ steps, so $\Gamma \vdash \floor*{P} \to Q_1$, since there is no application of Universal Generalization involving a free variable of $P$. Also $x_i$ cannot occur free in $P$, as it is involved in an application of Universal Generalization in the deduction of $Q$ from $\Gamma \cup \{P\}$. So we have a derivation of $\Gamma \vdash \floor*{P} \to Q$ as follows.
\begin{align*}
\Gamma &\vdash \floor*{P} \to Q \\
{\text{iff} \quad} \Gamma &\vdash \floor*{P} \to \forall x_i . Q_1 \\
{\text{if} \quad} \Gamma &\vdash \forall x_i . (\floor*{P} \to Q_1) \\
{\text{if} \quad} \Gamma &\vdash \floor*{P} \to Q_1. \\
\end{align*}
So $\Gamma \vdash \floor*{P} \to Q$ as required.

Case 4: Q follows from a previous pattern in the derivation by an application of Membership Introduction. So $Q$ is $\forall x_i . (x_i \in Q_1)$ with $x_i$ is free in $Q_1$, say, and $Q_1$ appears previously in the derivation. Thus $\Gamma \cup \{P\} \vdash Q_1$, and the derivation has fewer than $n$ steps, so $\Gamma \vdash \floor*{P} \to Q_1$, since there is no application of Universal Generalization involving a free variable of $P$. So we have a derivation of $\Gamma \vdash \floor*{P} \to Q$ as follows.
\begin{align*}
\Gamma &\vdash \floor*{P} \to Q \\
{\text{iff} \quad} \Gamma &\vdash \floor*{P} \to \forall x_i . (x_i \in Q_1) \\
{\text{iff} \quad} \Gamma &\vdash \floor*{P} \to \floor*{Q_1}, \\
\end{align*}
which follows by the hypothesis of induction $\Gamma \vdash \floor*{P} \to Q_1$ and the fact that $\Gamma \vdash Q_1 \to \floor*{Q_1}$ (by the Remark in Proposition~\ref{prop:p->ceilp}).

Case 5: Q follows from a previous pattern in the derivation by an application of Membership Elimination. The previous pattern must have the form $\forall x_i . (x_i \in Q)$, and can be deduced from $\Gamma \cup \{P\}$ by a derivation with fewer than $n$ steps, by just omitting the subsequent members from the original derivation from $\Gamma \cup \{P\} \vdash Q$. So we have $\Gamma \cup \{P\} \vdash \forall x_i . (x_i \in Q)$, and, applying the hypothesis of induction, $\Gamma \vdash \floor*{P} \to \forall x_i . (x_i \in Q)$. So we have a derivation of $\Gamma \vdash \floor*{P} \to Q$ as follows.
\begin{align*}
\Gamma &\vdash \floor*{P} \to Q \\
{\text{iff} \quad} \Gamma &\vdash \neg \floor*{P} \vee Q \\
{\text{iff} \quad} \Gamma &\vdash \neg \floor*{P} \vee \floor*{Q} \tag{Proposition~\ref{prop:predicatevee}} \\
{\text{iff} \quad} \Gamma &\vdash \neg \floor*{P} \vee \forall x_i . (x_i \in Q) \\
{\text{iff} \quad} \Gamma &\vdash \floor*{P} \to \forall x_i . (x_i \in Q),
\end{align*}
which is the hypothesis of induction. And this concludes our inductive proof.
\end{proof}

\begin{cor}[Closed-form Deduction Theorem]
If $P$ is closed, $\Gamma \cup \{P\} \vdash Q$ implies $\Gamma \vdash \floor*{P} \to Q$.
\end{cor}

\begin{thm} [Frame Rule]
	Let $\sigma \in \Sigma$ be a symbol in the signature. From $P_1 \to P_2$, deduce $\sigma(P_1) \to \sigma(P_2)$. In its most general form, $P_1 \to P_2$ deduces $\sigma(Q_1,\dots,P_1,\dots,Q_n) \to \sigma(Q_1,\dots, P_2, \dots, Q_n)$.
\end{thm}
\begin{proof}
	we write $\sigma(Q_1,\dots,P_i,\dots,Q_n)$ as $\sigma(P_i,\vec{Q})$ for short, for any $i \in \{1,2\}$.
	\begin{align*}
	&\vdash \sigma(P_1, \vec{Q}) \to \sigma(P_2,\vec{Q}) \\
	\text{iff} \quad &\vdash y \in (\sigma(P_1, \vec{Q}) \to \sigma(P_2,\vec{Q})) \\
	\text{iff} \quad &\vdash (y \in \sigma(P_1, \vec{Q})) \to (y \in \sigma(P_2, \vec{Q})) \\
	\text{iff} \quad &\vdash \exists z_1 . \exists \vec{z} . (z_1 \in P_1 \wedge \vec{z} \in \vec{Q} \wedge y \in \sigma(z_1, \vec{z})) \\
	&\to \exists z_2 . \exists \vec{z} . (z_2 \in P_2 \wedge \vec{z} \in \vec{Q} \wedge y \in \sigma(z_2, \vec{z})) \\
	\text{iff} \quad &\vdash \exists z_1 . \exists \vec{z} . (z_1 \in P_1 \wedge \vec{z} \in \vec{Q} \wedge y \in \sigma(z_1, \vec{z}) \\
	 &\quad \quad \quad \to z_1 \in P_2 \wedge \vec{z} \in \vec{Q} \wedge y \in \sigma(z_1, \vec{z})) \\
	\text{iff} \quad &\vdash \exists z_1. \exists \vec{z} . (z_1 \in P_1 \to z_1 \in P_2) \\
	\text{if} \quad &\vdash \exists z_1 .  (z_1 \in P_1 \to z_1 \in P_2) \\
	\text{if} \quad &\vdash P_1 \to P_2.
	\end{align*}
\end{proof}
\begin{cor} [Frame Rule as Implication]
	$\vdash \floor*{P \to Q} \to (\sigma(P) \to \sigma(Q))$
\end{cor}

\section{Inference rules}

\paragraph{Axioms}
$$
\infer{\Gamma \vdash A}{\cdot}
$$
where $A$ is an axiom. 

\paragraph{Inclusion}
$$
\infer{\Gamma \vdash P}{\cdot}
$$
where $P \in \Gamma$.

\paragraph{Modus Ponens}
$$
\infer{\Gamma \vdash P}
      {\Gamma \vdash Q \to P
      &\Gamma \vdash Q}
$$

\paragraph{Closed-Form Deduction Theorem}
$$
\infer{\Gamma \vdash P \to Q}
{\Gamma \cup \{P\} \vdash Q}
$$
where $P$ is closed.

\paragraph{Universal Generalization}
$$
\infer[(\forall x)]{\Gamma \vdash \forall x . P}
      {\Gamma \vdash P}
$$

\paragraph{Conjunction Splitting}
$$
\infer{\Gamma \vdash P \wedge Q}
      {\Gamma \vdash P
      &\Gamma \vdash Q}
$$

\end{document}
\grid
